<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Metronome</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/6.0.0/normalize.min.css" crossorigin="anonymous"> -Inc in bootstrap!-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.8.0/css/bootstrap-slider.min.css">

	<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/webcomponentsjs/0.7.24/webcomponents.min.js" type="application/javascript" type="application/javascript" crossorigin="anonymous"></script>-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="application/javascript" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-color/2.1.2/jquery.color.min.js" type="application/javascript" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" type="application/javascript" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" type="application/javascript" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" type="application/javascript" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/0.10.0/Tone.min.js" type="application/javascript" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.8.0/bootstrap-slider.min.js" type="application/javascript" crossorigin="anonymous"></script>
</head>

<body>
	<!--[if lt IE 7]>
		<p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
	<![endif]-->

	<style>
		/* Space out content a bit */

		body {
			padding-top: 1.5rem;
			padding-bottom: 1.5rem;
		}
		/* Everything but the jumbotron gets side spacing for mobile first views */

		.header,
		.marketing,
		.footer {
			padding-right: 1rem;
			padding-left: 1rem;
		}
		/* Custom page header */

		.header {
			padding-bottom: 1rem;
			border-bottom: .05rem solid #e5e5e5;
		}
		/* Make the masthead heading the same height as the navigation */

		.header h3 {
			margin-top: 0;
			margin-bottom: 0;
			line-height: 3rem;
		}
		/* Custom page footer */

		.footer {
			padding-top: 1.5rem;
			color: #777;
			border-top: .05rem solid #e5e5e5;
		}
		/* Customize container */

		@media (min-width: 48em) {
			.container {
				max-width: 46rem;
			}
		}
		/* Supporting marketing content */

		.marketing {
			margin: 3rem 0;
		}

		.marketing p+h4 {
			margin-top: 1.5rem;
		}
		/* Responsive: Portrait tablets and up */

		@media screen and (min-width: 48em) {
			/* Remove the padding we set earlier */
			.header,
			.marketing,
			.footer {
				padding-right: 0;
				padding-left: 0;
			}
			/* Space out the masthead */
			.header {
				margin-bottom: 2rem;
			}
			/* Remove the bottom border on the jumbotron for visual effect */
			.jumbotron {
				border-bottom: 0;
			}
		}
	</style>

	<div class="container">
		<div class="header clearfix">
			<nav>
				<ul class="nav nav-pills float-right">
					<li class="nav-item">
						<a class="nav-link active" href="#">Home <span class="sr-only">(current)</span></a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">About</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Contact</a>
					</li>
				</ul>
			</nav>
			<h3 class="text-muted">Metronome</h3>
		</div>

		<div class="jumbotron text-center">
			<!-- Time -->
			<h2>
				<i class="fa fa-clock-o"></i>&nbsp;<label id="TimeLabel">0:00:00</label>
			</h2>
			<br />
			<!-- Controls -->
			<button id="PlayPauseButton" type="button" class="btn btn-primary btn-lg"><i class="fa fa-play"></i></button>
			<button id="StopButton" type="button" class="btn btn-primary btn-lg"><i class="fa fa-stop"></i></button>
			<button id="VolumeDownButton" type="button" class="btn btn-primary btn-lg"><i class="fa fa-volume-down"></i></button>
			<button id="VolumeUpButton" type="button" class="btn btn-primary btn-lg"><i class="fa fa-volume-up"></i></button>
			<button id="VolumeOffButton" type="button" class="btn btn-primary btn-lg"><i class="fa fa-volume-off"></i>&nbsp;<span id="VolumeSpan">+0</span>db</button>
			<hr />
			<div class="row">
				<!-- BPM -->
				<div class="input-group col-md-6">
					<span class="input-group-addon"><i class="fa fa-spinner"></i>BPM</span>
					<input id="BPMInput" type="number" class="form-control" value="100" min="10" max="220">
					<div class="input-group-btn">
						<button id="BPMIncreaseButton" type="button" class="btn btn-primary btn-sm"><i class="fa fa-plus"></i></button>
						<button id="BPMDecreaseButton" type="button" class="btn btn-primary btn-sm"><i class="fa fa-minus"></i></button>
					</div>
					<button id="BPMTapButton" type="button" class="btn btn-secondary">Tap</button>
				</div>
				<!-- BPM Slider -->
				<div class="input-group col-md-6">
					<div class="m-auto">
						<input id="BPMSlider" type="hidden" />
					</div>
				</div>
			</div>
			<br />
			<!-- BPM Ramp -->
			<div class="input-group">
				<span class="input-group-addon"><i class="fa fa-arrow-up"></i>BPM Ramp</span>
				<input id="BPMRampFromInput" type="number" class="form-control" value="100" min="10" max="220">
				<span class="input-group-addon">To</span>
				<input id="BPMRampToInput" type="number" class="form-control" value="100" min="10" max="220">
				<span class="input-group-addon">Over</span>
				<input id="BPMRampTimeInput" type="number" class="form-control" value="60" min="1" max="1200">
				<span class="input-group-addon">Seconds</span>
				<span class="input-group-addon">
       				<input id="BPMRampEnabledInput" type="checkbox" aria-label="Checkbox for BPM Ramp enable">
      			</span>
			</div>
			<hr />
			<div class="row">
				<!-- Meter -->
				<div class="input-group col-md-6">
					<div class="input-group">
						<span class="input-group-addon"><i class="fa fa-tachometer"></i>Meter</span>
						<input id="BeatsInput" type="number" class="form-control" value="4" min="0" max="10">
						<span class="input-group-addon">/</span>
						<input id="SubunitsInput" type="number" class="form-control" value="4" min="0" max="4">
						<div class="input-group-btn">
							<button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
							<div class="dropdown-menu dropdown-menu-right">
								<a class="dropdown-item" href="javascript:setMeter(1,1)">1</a>
								<a class="dropdown-item" href="javascript:setMeter(2,1)">2</a>
								<a class="dropdown-item" href="javascript:setMeter(3,1)">3</a>
								<a class="dropdown-item" href="javascript:setMeter(4,1)">4</a>
								<a class="dropdown-item" href="javascript:setMeter(2,4)">2/4</a>
								<a class="dropdown-item" href="javascript:setMeter(3,4)">3/4</a>
								<a class="dropdown-item" href="javascript:setMeter(4,4)">4/4</a>
							</div>
						</div>
					</div>
				</div>
				<!-- Subdivisions -->
				<div class="input-group col-md-6">
					<span class="input-group-addon"><i class="fa fa-music"></i>Subdivisions</span>
					<input id="SubdivisionsInput" type="text" class="form-control" data-toggle="dropdown" placeholder="None" disabled style="background-color:white;">
					<div class="input-group-btn">
						<button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
						<div class="dropdown-menu dropdown-menu-right">
							<a class="dropdown-item" href="javascript:setSubdivisions('None')">None</a>
							<a class="dropdown-item" href="javascript:setSubdivisions('Single')">Single</a>
							<a class="dropdown-item" href="javascript:setSubdivisions('Duple')">Duple</a>
							<a class="dropdown-item" href="javascript:setSubdivisions('Triple')">Triple</a>
							<a class="dropdown-item" href="javascript:setSubdivisions('Quadruple')">Quadruple</a>
							<a class="dropdown-item" href="javascript:setSubdivisions('Quintuple')">Quintuple</a>
							<a class="dropdown-item" href="javascript:setSubdivisions('Sextuple')">Sextuple</a>
							<a class="dropdown-item" href="javascript:setSubdivisions('Septuple')">Septuple</a>
							<div role="separator" class="dropdown-divider"></div>
							<a class="dropdown-item" href="javascript:setSubdivisions('Tripple 3rd')">Tripple 3rd</a>
							<a class="dropdown-item" href="javascript:setSubdivisions('Quadruple 4th')">Quadruple 4th</a>
						</div>
					</div>
				</div>
			</div>
			<hr />
			<div id="Pills">
				<span class="badge badge-pill badge-default" style="margin: 3px">1</span>
				<span class="badge badge-pill badge-default" style="margin: 3px">2</span>
				<span class="badge badge-pill badge-default" style="margin: 3px">3</span>
				<span class="badge badge-pill badge-default" style="margin: 3px">4</span>
			</div>
		</div>

		<div class="row marketing">
			<div class="col-lg-6">
				<h4>Subheading</h4>
				<p>Donec id elit non mi porta gravida at eget metus. Maecenas faucibus mollis interdum.</p>

				<h4>Subheading</h4>
				<p>Morbi leo risus, porta ac consectetur ac, vestibulum at eros. Cras mattis consectetur purus sit amet fermentum.</p>

				<h4>Subheading</h4>
				<p>Maecenas sed diam eget risus varius blandit sit amet non magna.</p>
			</div>

			<div class="col-lg-6">
				<h4>Subheading</h4>
				<p>Donec id elit non mi porta gravida at eget metus. Maecenas faucibus mollis interdum.</p>

				<h4>Subheading</h4>
				<p>Morbi leo risus, porta ac consectetur ac, vestibulum at eros. Cras mattis consectetur purus sit amet fermentum.</p>

				<h4>Subheading</h4>
				<p>Maecenas sed diam eget risus varius blandit sit amet non magna.</p>
			</div>
		</div>

		<footer class="footer">
			<p>&copy; Company 2017</p>
		</footer>
	</div>

	<script type="application/javascript">
		class Timer {
			constructor() {
				this.startTime = null;
				this.timer = null;
				this.interval = 250; // adjust this number to affect granularity, lower numbers are more accurate, but more CPU-expensive
			}
			start(callback) {
				if (!this.startTime) {
					this.startTime = new Date().getTime();
				}
				this.timer = setInterval(() => {
					const now = new Date().getTime();
					const distance = now - this.startTime;
					const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
					const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
					const s = Math.floor((distance % (1000 * 60)) / 1000);
					const ms = Math.floor((distance % 1000));
					callback(h, m, s, ms);

				}, this.interval);
			}
			pause() {
				if (this.timer) {
					clearInterval(this.timer);
				}
			}
			stop() {
				if (this.timer) {
					clearInterval(this.timer);
				}
				this.startTime = null;
			}
		}
	</script>
	<script type="application/javascript">
		//https://tonejs.github.io/docs/

		// :: Time ::

		const timer = new Timer();
		const timeLabel = $('#TimeLabel');

		// :: Controls ::

		const playPauseButton = $('#PlayPauseButton');
		const stopButton = $('#StopButton');
		const volumeUpButton = $('#VolumeUpButton');
		const volumeDownButton = $('#VolumeDownButton');
		const volumeOffButton = $('#VolumeOffButton');
		const volumeSpan = $('#VolumeSpan');
		let playing = false;

		playPauseButton.click(() => {

			if (playing) {
				pause();
			} else {
				play();
			}
			playing = !playing;
		});
		stopButton.click(() => {

			stop();
			playing = false;
		});
		volumeUpButton.click(() => {

			volumeSpan.show();
			Tone.Master.mute = false;

			const clampedVolume = parseInt(Math.min(Tone.Master.volume.value + 3, 24));
			volumeSpan.text(clampedVolume >= 0 ? '+' + clampedVolume : clampedVolume);
			Tone.Master.volume.value = clampedVolume;
		});
		volumeDownButton.click(() => {

			volumeSpan.show();
			Tone.Master.mute = false;

			const clampedVolume = parseInt(Math.max(Tone.Master.volume.value - 3, -24));
			volumeSpan.text(clampedVolume >= 0 ? '+' + clampedVolume : clampedVolume);
			Tone.Master.volume.value = clampedVolume;
		});
		volumeOffButton.click(() => {

			Tone.Master.mute ? volumeSpan.show() : volumeSpan.hide(); // Invert cuz we gonna change it now
			Tone.Master.mute = !Tone.Master.mute;
		});

		// ==== BPM ====

		// :: BPM Input ::

		const bpmInput = $('#BPMInput');
		const bpmIncreaseButton = $('#BPMIncreaseButton');
		const bpmDecreaseButton = $('#BPMDecreaseButton');
		const bpmTapButton = $('#BPMTapButton');
		let taps = [];
		const tapTimeout = 1000 * 4;

		bpmInput.change(() => setBPM(parseInt(bpmInput.val())));
		bpmIncreaseButton.click(() => setBPM(parseInt(bpmInput.val()) + 10));
		bpmDecreaseButton.click(() => setBPM(parseInt(bpmInput.val()) - 10));
		bpmTapButton.click(() => {

			const now = new Date().getTime();
			if (taps.length > 0 && (now - taps[taps.length - 1]) > tapTimeout) {
				taps = [];
				setBPM(parseInt(100));
			}
			taps.push(now);
			if (taps.length === 1) {
				return;
			}
			const tapsDifference = [];
			for (let index = 1; index < taps.length; index++) {
				tapsDifference.push(taps[index] - taps[index - 1]);
			}
			const avg = (tapsDifference.reduce((a, b) => a + b) / tapsDifference.length);
			const bpm = (1000 * 60) / avg;
			setBPM(parseInt(bpm));
		});

		// :: BPM Slider ::

		//https://github.com/seiyria/bootstrap-slider

		const bpmSlider = $('#BPMSlider').bootstrapSlider({
			min: parseInt(bpmInput.attr('min')),
			max: parseInt(bpmInput.attr('max')),
			value: getBPM(),
			step: 1,
		});
		bpmSlider.change(() => setBPM(bpmSlider.bootstrapSlider('getValue')));

		// :: BPM Ramp ::
		
		const bpmRampFromInput = $('#BPMRampFromInput');
		const bpmRampToInput = $('#BPMRampToInput');
		const bpmRampTimeInput = $('#BPMRampTimeInput');
		const bpmRampEnabledInput = $('#BPMRampEnabledInput');

		bpmRampFromInput.change(() => {
			
			Tone.Transport.bpm.value = parseInt(bpmRampFromInput.val());
			Tone.Transport.bpm.rampTo(parseInt(bpmRampToInput.val()), parseInt(bpmRampTimeInput.val()));
		});
		bpmRampToInput.change(() => {
			
			Tone.Transport.bpm.value = parseInt(bpmRampFromInput.val());
			Tone.Transport.bpm.rampTo(parseInt(bpmRampToInput.val()), parseInt(bpmRampTimeInput.val()));
		});
		bpmRampTimeInput.change(() => {
			
			Tone.Transport.bpm.value = parseInt(bpmRampFromInput.val());
			Tone.Transport.bpm.rampTo(parseInt(bpmRampToInput.val()), parseInt(bpmRampTimeInput.val()));
		});
		bpmRampEnabledInput.change(() => {

			const bpmRampEnabled = bpmRampEnabledInput.is(':checked');
			
			bpmInput.prop('disabled', bpmRampEnabled);
			bpmIncreaseButton.prop('disabled', bpmRampEnabled);
			bpmDecreaseButton.prop('disabled', bpmRampEnabled);
			bpmTapButton.prop('disabled', bpmRampEnabled);
			bpmRampEnabled ? bpmSlider.bootstrapSlider('disable') : bpmSlider.bootstrapSlider('enable');

			bpmRampFromInput.prop('disabled', !bpmRampEnabled);
			bpmRampToInput.prop('disabled', !bpmRampEnabled);
			bpmRampTimeInput.prop('disabled', !bpmRampEnabled);
		});

		// Otherwise may persist over refresh!
		bpmRampEnabledInput.prop("checked", false);	
		bpmRampFromInput.prop('disabled', true);
		bpmRampToInput.prop('disabled', true);
		bpmRampTimeInput.prop('disabled', true);

		// :: Meter ::

		const beatsInput = $('#BeatsInput');
		const subunitsInput = $('#SubunitsInput');

		beatsInput.change(() => setMeter(parseInt(beatsInput.val()), parseInt(subunitsInput.val())));
		subunitsInput.change(() => setMeter(parseInt(beatsInput.val()), parseInt(subunitsInput.val())));

		// :: Subdivisions ::

		const Subdivisions = {
			None: 'None',
			Single: 'Single',
			Duple: 'Duple',
			Triple: 'Triple',
			Quadruple: 'Quadruple',
			Quintuple: 'Quintuple',
			Sextuple: 'Sextuple',
			Septuple: 'Septuple',
			Tripple3rd: 'Tripple 3rd',
			Quadruple4th: 'Quadruple 4th',
		};
		const subdivisionsInput = $('#SubdivisionsInput');

		subdivisionsInput.click(() => setSubdivisions(parseInt(subdivisionsInput.val())));

		// :: Pills ::

		const pills = $('#Pills');

		// :: Sounds ::

		/*
		The top number of the time signature tells you how many beats to count. This could be any number. 
		Most often the number of beats will fall between 2 and 12.

		The bottom number tells you what kind of note to count. That is, whether to count the beats as quarter notes, eighth notes, 
		or sixteenth notes. So the only numbers you will see as the bottom number (the denominator) will correspond to note values:

			1 = whole note (you’ll never see this)
			2 = half note
			4 = quarter note
			8 = eighth note
			16 = sixteenth note 
		*/

		//The time signature as just the numerator over 4. For example 4/4 would be just 4 and 6/8 would be 3.
		Tone.Transport.timeSignature = getMeter();
		Tone.Transport.bpm.value = getBPM();

		//console.log('timeSignature', Tone.Transport.timeSignature);
		// console.log('value', Tone.Transport.bpm.value);

		const accent = new Tone.Player({
			url: "./Sounds/Ping Hi.wav",
		}).toMaster();
		const beat = new Tone.Player({
			url: "./Sounds/Ping Low.wav",
		}).toMaster();

		let currentNote = 0;
		
		//https://tonejs.github.io/docs/#types/Time
		Tone.Transport.scheduleRepeat((time) => {

			currentNote = (currentNote % Tone.Transport.timeSignature) + 1;
			console.log('currentNote', currentNote);
			const currentPill = $(pills.children()[currentNote - 1]);
			console.log('currentPill', currentPill.css('background-color'));
			
			if (currentNote === 1) {
				currentPill.animate({ backgroundColor: "rgb(255,0,0)" }, 50, () => currentPill.animate({ backgroundColor: '#636c72' }));
				accent.start(time);
			} else {
				currentPill.animate({ backgroundColor: "rgb(0,255,0)" }, 50, () => currentPill.animate({ backgroundColor: '#636c72' }));
				beat.start(time);
			}

			bpmSlider.bootstrapSlider('setValue', parseInt(Tone.Transport.bpm.value));
			bpmInput.val(parseInt(Tone.Transport.bpm.value));
		}, "4n");

		// TODO: Reset ALL ui

		// :: Functions ::

		function play() {

			// if (bpmRampEnabledInput.is(':checked')) {
			// 	setBPM(parseInt(bpmRampFromInput.val()));
			// }

			if (bpmRampEnabledInput.is(':checked')) {

				setBPM(parseInt(bpmRampFromInput.val()));
				Tone.Transport.bpm.value = parseInt(bpmRampFromInput.val());
				Tone.Transport.bpm.rampTo(parseInt(bpmRampToInput.val()), parseInt(bpmRampTimeInput.val()));
			} else {

				Tone.Transport.bpm.value = getBPM();
				Tone.Transport.bpm.rampTo(Tone.Transport.bpm.value, 0);
			}

			playPauseButton.html('<i class="fa fa-pause"></i>');
			Tone.Transport.start();
			timer.start((h, m, s, ms) => timeLabel.text(h + ':' + ("0" + m).slice(-2) + ':' + ("0" + s).slice(-2)));
		}

		function pause() {

			playPauseButton.html('<i class="fa fa-play"></i>');
			Tone.Transport.pause();
			timer.pause();
		}

		function stop() {

			playPauseButton.html('<i class="fa fa-play"></i>');
			Tone.Transport.stop();
			timer.stop();
			timeLabel.text('0:00:00');
		}

		function getBPM() {

			return parseInt(bpmInput.val());
		}

		function setBPM(value) {

			const clampedValue = Math.max(Math.min(value, bpmInput.attr('max')), bpmInput.attr('min'));
			bpmSlider.bootstrapSlider('setValue', clampedValue);
			bpmInput.val(clampedValue);
			Tone.Transport.bpm.value = clampedValue;
		}

		function getMeter() {

			const beats = parseInt(beatsInput.val());
			const subunits = parseInt(subunitsInput.val());
			return [beats, subunits];
		}

		function setMeter(beats, subunits) {

			beatsInput.val(beats);
			subunitsInput.val(subunits);
			Tone.Transport.timeSignature = [beats, subunits];

			pills.empty();
			for (var index = 1; index <= Tone.Transport.timeSignature; index++) {
				pills.append($('<span>').addClass('badge badge-pill badge-default').css('margin', '3px').text(index));
				//pills.append(`<span class="badge badge-pill badge-default">${index}</span>`);				
			}
		}

		function getSubdivisions() {

			return _(Subdivisions).findKey(value => value === subdivisionsInput.val());
		}

		function setSubdivisions(subdivisions) {

			subdivisionsInput.val(Subdivisions[subdivisions]);
		}
	</script>

	<script>
		/*!
		 * IE10 viewport hack for Surface/desktop Windows 8 bug
		 * Copyright 2014-2017 The Bootstrap Authors
		 * Copyright 2014-2017 Twitter, Inc.
		 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
		 */

		// See the Getting Started docs for more information:
		// https://getbootstrap.com/getting-started/#support-ie10-width

		(function () {
			'use strict'

			if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
				var msViewportStyle = document.createElement('style')
				msViewportStyle.appendChild(
					document.createTextNode(
						'@-ms-viewport{width:auto!important}'))
				document.head.appendChild(msViewportStyle)
			}

		}())
	</script>
</body>

</html>